---
import Layout from '@layouts/Layout.astro'
import Head from '@components/Head.astro'
import Repo from '@components/Repo.astro'

const commit: { html_url: string; sha: string } = await fetch('https://api.github.com/repos/notgabry/gabryy.me/commits/main')
    .then((a) => a.json())
    .catch(() => {})

let repos: { html_url: string; full_name: string; stargazers_count: number; language: string; description: string; fork: boolean; created_at: string }[] = await fetch('https://api.github.com/users/notgabry/repos?sort=stars&order=desc')
    .then((a) => a.json())
    .catch(() => [])

if (repos.length) {
    repos = repos.filter((a) => a.stargazers_count)
    repos.sort((a, b) => {
        const comparison = b.stargazers_count - a.stargazers_count

        if (comparison == 0) {
            return new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
        }

        return comparison
    })
}
---

<Layout title="notgabry">
    <main class="mt-10 mx-6">
        <header class="text-center mb-9 font-young-serif">
            <Head description="⭐ my best github projects" />
        </header>

        {
            repos.length ? (
                repos.map((e, i) => {
                    if (!e.fork) return <Repo name={e.full_name} language={e.language} description={e.description} stars={e.stargazers_count} url={e.html_url} />
                })
            ) : (
                <section class="bg-red-500 border border-red-800 text-p-text text-center rounded-md max-w-md py-2 mx-auto font-space">
                    <h3 class="font-bold text-2xl">Load Error</h3>
                    <p class="text-md font-space">Cannot contact github.com, please retry later</p>
                </section>
            )
        }
    </main>

    <hr class="my-6 border-gray-600 mx-4" />
    <footer class="mx-4 font-josefin font-bold mb-10 text-gray-500">
        <p class="text-md">📃 Code under <a href="https://github.com/NotGabry/gabryy.me/blob/main/LICENSE" class="decoration-dashed hover:underline">MIT</a> license.</p>
        <p class="text-md">🍁 GitHub Commit <a class="decoration-dashed hover:underline" href={commit.html_url}>{String(commit.sha || '00000').substring(0, 5)}.</a></p>
    </footer>
</Layout>
